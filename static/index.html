<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizons - VM Control</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #00d4ff; }
        .card { background: #16213e; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .status { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .indicator { width: 12px; height: 12px; border-radius: 50%; }
        .running { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
        .stopped { background: #ff4757; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: #00d4ff; color: #000; }
        .btn-danger { background: #ff4757; color: #fff; }
        .btn-warning { background: #ffa502; color: #000; }
        .btn-secondary { background: #57606f; color: #fff; }
        .btn:hover { opacity: 0.8; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .section { margin-top: 15px; }
        .section h3 { margin-bottom: 10px; font-size: 14px; color: #888; text-transform: uppercase; }
        input[type="file"] { display: none; }
        .file-label { display: inline-block; padding: 10px 20px; background: #00d4ff; color: #000; border-radius: 4px; cursor: pointer; }
        .file-label:hover { opacity: 0.8; }
        .iso-info { margin-top: 10px; padding: 10px; background: #0f3460; border-radius: 4px; }
        .vnc-link { display: inline-block; margin-top: 10px; color: #00d4ff; }
        .progress { display: none; margin-top: 10px; }
        .progress-bar { height: 4px; background: #0f3460; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #00d4ff; width: 0%; transition: width 0.3s; }
        .about { opacity: 50%; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ Horizons</h1>
        <div class="card">
            <div class="status">
                <div class="indicator" id="statusIndicator"></div>
                <span id="statusText">Checking...</span>
            </div>
            <div class="section">
                <h3>Power Controls</h3>
                <button class="btn btn-primary" id="startBtn" onclick="startVM()">Start VM</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopVM(false)">Shutdown</button>
                <button class="btn btn-danger" id="forceStopBtn" onclick="stopVM(true)">Force Stop</button>
                <button class="btn btn-warning" id="rebootBtn" onclick="rebootVM(false)">Reboot</button>
                <button class="btn btn-warning" id="forceRebootBtn" onclick="rebootVM(true)">Force Reboot</button>
            </div>
        </div>
        <div class="card">
            <h3>ISO Management</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 10px;">Max size: 6 GB. ISO will be used on next boot.</p>
            <label class="file-label">
                <input type="file" id="isoFile" accept=".iso" onchange="uploadISO()">
                Upload ISO
            </label>
            <button class="btn btn-secondary" onclick="detachISO()">Detach & Delete ISO</button>
            <div class="progress" id="uploadProgress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>
            <div class="iso-info" id="isoInfo" style="display: none;">
                <strong>Attached:</strong> <span id="isoName"></span>
            </div>
        </div>
        <div class="card">
            <h3>Console Access</h3>
            <a href="/vnc.html" class="vnc-link" target="_blank">Open VNC Console →</a>
        </div>
        <p class="about">Horizons VMManager © Qwaderton, 2025</p>
    </div>
    <script>
        async function api(path, method = 'GET', body = null) {
            const opts = { method, headers: {} };
            if (body) {
                opts.body = body;
            }
            const res = await fetch('/api/' + path, opts);
            return res.json();
        }
        async function updateStatus() {
            try {
                const status = await api('status');
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                if (status.running) {
                    indicator.className = 'indicator running';
                    text.textContent = 'Running';
                } else {
                    indicator.className = 'indicator stopped';
                    text.textContent = 'Stopped';
                }
                document.getElementById('startBtn').disabled = status.running;
                document.getElementById('stopBtn').disabled = !status.running;
                document.getElementById('forceStopBtn').disabled = !status.running;
                document.getElementById('rebootBtn').disabled = !status.running;
                document.getElementById('forceRebootBtn').disabled = !status.running;
                if (status.iso_attached) {
                    document.getElementById('isoInfo').style.display = 'block';
                    document.getElementById('isoName').textContent = status.iso_name;
                } else {
                    document.getElementById('isoInfo').style.display = 'none';
                }
            } catch (e) {
                console.error('Status update failed:', e);
            }
        }
        async function startVM() {
            await api('start', 'POST');
            setTimeout(updateStatus, 1000);
        }
        async function stopVM(force) {
            await api('stop?force=' + force, 'POST');
            setTimeout(updateStatus, 1000);
        }
        async function rebootVM(force) {
            await api('reboot?force=' + force, 'POST');
        }
        async function uploadISO() {
            const file = document.getElementById('isoFile').files[0];
            if (!file) return;
            const form = new FormData();
            form.append('iso', file);
            const progress = document.getElementById('uploadProgress');
            const fill = document.getElementById('progressFill');
            progress.style.display = 'block';
            const xhr = new XMLHttpRequest();
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    fill.style.width = (e.loaded / e.total * 100) + '%';
                }
            };
            xhr.onload = () => {
                progress.style.display = 'none';
                fill.style.width = '0%';
                updateStatus();
            };
            xhr.open('POST', '/api/iso/upload');
            xhr.send(form);
        }
        async function detachISO() {
            await api('iso/detach', 'POST');
            updateStatus();
        }
        updateStatus();
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>